---
title: Profile Settings
layout: aesthetihawk
active_tab: profile
---

<head>
    <link rel="stylesheet" href="{{ site.baseurl }}/assets/css/aesthetihawk/shake.css">
</head>

<form id="profileSettingsForm">
    <!-- Personal Information Section -->
    <div class="bg-neutral-800 rounded-lg shadow-md p-6 mb-6 border-neutral-700 border">
        <h2 class="text-xl font-semibold mb-6">Personal Information</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Full Name -->
            <div>
                <label for="nameChangeInput" class="block text-sm font-medium text-gray-300 mb-1">Full
                    Name</label>
                <input type="text" id="nameChangeInput" name="fullName"
                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    value="" onchange="checkForChanges()" autocomplete="off">
            </div>

            <!-- User ID -->
            <div>
                <label for="uidChangeInput" class="block text-sm font-medium text-gray-300 mb-1">User
                    ID</label>
                <input type="text" id="uidChangeInput" name="userId"
                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    value="" onchange="checkForChanges()" autocomplete="off">
            </div>

            <!-- Email -->
            <div>
                <label for="emailChangeInput" class="block text-sm font-medium text-gray-300 mb-1">Email
                    Address</label>
                <input type="email" id="emailChangeInput" name="new-email"
                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    value="" onchange="checkForChanges()" autocomplete="off">
            </div>

            <!-- Kasm Server Toggle -->
            <div class="flex items-center">
                <label for="kasmChangeInput" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="kasmChangeInput" class="sr-only" onchange="checkForChanges()">
                        <div class="block bg-neutral-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform">
                        </div>
                    </div>
                    <div class="ml-3 text-sm font-medium text-gray-300">
                        Enable Kasm Server
                    </div>
                </label>
            </div>

            <!-- Password Change -->
            <div>
                <label for="password" class="block text-sm font-medium text-gray-300 mb-1">New
                    Password</label>
                <input type="password" id="password" name="password"
                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="Enter new password" onchange="checkForChanges()" autocomplete="new-password">
            </div>
        </div>
    </div>

    <!-- School Section -->
    <div class="bg-neutral-800 rounded-lg shadow-md p-6 mb-6 border-neutral-700 border">
        <h2 class="text-xl font-semibold mb-6">School Information</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- High School Selection -->
            <div>
                <label for="schoolChangeInput" class="block text-sm font-medium text-gray-300 mb-1">High School</label>
                <select id="schoolChangeInput" name="school"
                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    onchange="checkForChanges()">
                    <option value="" disabled>Select Your High School</option>
                    <option value="Abraxas High School">Abraxas</option>
                    <option value="Del Norte High School">Del Norte</option>
                    <option value="Mt Carmel High School">Mt Carmel</option>
                    <option value="Poway High School">Poway</option>
                    <option value="Poway to Palomar">Poway to Palomar</option>
                    <option value="Rancho Bernardo High School">Rancho Bernardo</option>
                    <option value="Westview High School">Westview</option>
                </select>
            </div>

            <!-- Student ID -->
            <div>
                <label for="sidChangeInput" class="block text-sm font-medium text-gray-300 mb-1">Student
                    ID (7 digits)</label>
                <input type="text" id="sidChangeInput" name="studentId"
                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    value="" onchange="checkForChanges()" autocomplete="off">
            </div>
        </div>
    </div>

    <!-- Classes Section -->
    <div class="bg-neutral-800 rounded-lg shadow-md p-6 mb-6 border-neutral-700 border">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Classes</h2>
            <button type="button" id="addClassBtn"
                class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 focus:outline-none">
                Add Class
            </button>
        </div>
    
        <div id="classesContainer">
            <!-- Classes will be loaded here dynamically -->
            <p class="text-gray-400 text-center py-4">Loading classes...</p>
        </div>
    </div>

<div class="bg-neutral-800 rounded-lg shadow-md p-6 mb-6 border-neutral-700 border">
    <h2 class="text-xl font-semibold mb-6">Group Information</h2>

    <div id="springGroupInfo" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="col-span-1 md:col-span-2 text-center text-gray-400">
            Loading group information...
        </div>
    </div>
</div>

<!-- ============================= -->
<!-- FRONTEND-ONLY GROUPING AGENT  -->
<!-- Paste this block after Group Information, before Join a Group -->
<!-- ============================= -->

<div class="bg-neutral-800 rounded-lg shadow-md p-6 mb-6 border-neutral-700 border">
  <div class="flex items-start justify-between gap-4 mb-4">
    <div>
      <h2 class="text-xl font-semibold">Grouping Agent (Frontend-Only)</h2>
      <p class="text-sm text-gray-400">
        Learns from historical outcomes (student + teacher ratings) and recommends groups locally.
      </p>
    </div>
    <div class="text-sm text-gray-300" id="gaStatus"></div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-1">Task Type</label>
      <select id="gaTaskType" class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700">
        <option value="CSA_FRQ">CSA_FRQ</option>
        <option value="WEB_APP">WEB_APP</option>
        <option value="DATA_SCI">DATA_SCI</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-300 mb-1">Difficulty (1-5)</label>
      <input id="gaDifficulty" type="number" min="1" max="5" value="3"
        class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700">
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-300 mb-1">Group Size</label>
      <input id="gaGroupSize" type="number" min="2" max="6" value="4"
        class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700">
    </div>

    <div class="flex items-end gap-2">
      <button id="gaTrainBtn"
        class="w-1/2 px-4 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600">
        Train
      </button>
      <button id="gaRecommendBtn"
        class="w-1/2 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
        Recommend
      </button>
    </div>
  </div>

  <div class="mt-6">
    <h3 class="text-lg font-semibold text-gray-200 mb-2">Recommendations</h3>
    <div id="gaRecs" class="space-y-3">
      <div class="text-gray-400 text-sm">No recommendations yet.</div>
    </div>
  </div>

  <div class="mt-6 border-t border-gray-700 pt-4">
    <h3 class="text-lg font-semibold text-gray-200 mb-2">Record Outcome</h3>
    <p class="text-sm text-gray-400 mb-3">
      Save ratings locally to improve future recommendations.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-300 mb-1">Group Members (comma-separated IDs)</label>
        <input id="gaOutcomeMembers" placeholder="u1,u2,u3,u4"
          class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-1">Student Avg (1-5)</label>
        <input id="gaStudentRating" type="number" min="1" max="5" value="4"
          class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-1">Teacher (1-5)</label>
        <input id="gaTeacherRating" type="number" min="1" max="5" value="4"
          class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700" />
      </div>
    </div>

    <div class="mt-3 flex gap-2">
      <button id="gaSaveOutcomeBtn"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
        Save Outcome
      </button>
      <button id="gaResetLocalBtn"
        class="px-4 py-2 bg-neutral-700 text-gray-200 rounded-lg hover:bg-neutral-600 border border-gray-600">
        Reset Local Model
      </button>
    </div>

    <div class="mt-2 text-sm text-gray-400" id="gaOutcomeStatus"></div>
  </div>
</div>


<div class="bg-neutral-800 rounded-lg shadow-md p-6 mb-6 border-neutral-700 border">
    <div class="flex items-start justify-between gap-4 mb-4">
        <div>
            <h2 class="text-xl font-semibold">Join a Group</h2>
        </div>
        <div id="joinGroupStatus" class="text-sm text-gray-300"></div>
    </div>

    <div class="grid grid-cols-1 gap-4">
        <div>
            <label for="groupSearchInput" class="block text-sm font-medium text-gray-300 mb-1">Search
                Groups</label>
            <div class="flex gap-2">
                <input id="groupSearchInput" type="text" placeholder="Enter a group name"
                    class="flex-1 px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    autocomplete="off">
                <button id="groupSearchBtn" type="button"
                    class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 focus:outline-none">
                    Search
                </button>
            </div>
        </div>
        <div id="groupResultsList" class="bg-neutral-700 border border-gray-600 rounded-lg max-h-64 overflow-y-auto hidden">
        </div>
    </div>
</div>

<div class="bg-neutral-800 rounded-lg shadow-md p-6 mb-6 border-neutral-700 border">
    <h2 class="text-xl font-semibold mb-6">Select Your Persona</h2>
    
    <div id="personaSelectionContainer">
        <p class="text-gray-400 text-center py-4">Loading personas...</p>
    </div>
</div>


</form>

<script type="module">
    import { pythonURI, javaURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';

    /**
     * API Request Chaining Implementation
     * ==================================
     * This script demonstrates chaining API requests where:
     * 1. First fetch user identity from Java backend (required for all subsequent calls)
     * 2. Then chain to fetch user's groups using the personId from step 1
     * 
     * Benefits:
     * - Proper dependency management (can't fetch groups without personId)
     * - Single cached personId reused for join/leave operations
     * - Clear error propagation through the chain
     */

    document.addEventListener("DOMContentLoaded", () => {
        const springGroupInfo = document.getElementById('springGroupInfo');
        const groupSearchInput = document.getElementById('groupSearchInput');
        const groupResultsList = document.getElementById('groupResultsList');
        const joinGroupStatus = document.getElementById('joinGroupStatus');
        
        // Module-level cache for current user data - fetched once, reused throughout
        let currentPersonId = null;
        let currentUid = null;
        let userGroupIds = new Set(); // Track user's group IDs for O(1) lookup

        /**
         * CHAINED API PATTERN:
         * Step 1: Fetch user identity -> Step 2: Use personId to fetch groups
         * 
         * This uses .then() chaining to demonstrate the pattern where
         * each subsequent request depends on data from the previous one.
         */
        fetch(`${javaURI}/api/person/get`, fetchOptions)
            .then(response => {
                // Handle authentication errors
                if (response.status === 401) {
                    springGroupInfo.innerHTML = `<p class="text-gray-400 col-span-2 text-center">Please sign in to view group information.</p>`;
                    groupSearchInput.disabled = true;
                    return null; // Stop the chain
                }
                if (!response.ok) {
                    throw new Error(`Failed to fetch user: ${response.status}`);
                }
                return response.json();
            })
            .then(personData => {
                if (!personData) return null; // Chain was stopped
                
                // Cache user identity for reuse in join/leave operations
                currentPersonId = personData.id;
                currentUid = personData.uid;

                if (!currentPersonId || !currentUid) {
                    springGroupInfo.innerHTML = `<p class="text-gray-400 col-span-2 text-center">Unable to verify user identity for group data.</p>`;
                    return null;
                }

                // CHAIN: Now fetch groups using the personId we just obtained
                // This request DEPENDS on having currentPersonId from the previous call
                return fetch(`${javaURI}/api/groups/person/${currentPersonId}`, fetchOptions);
            })
           
            .then(groupResp => {
                if (!groupResp) return null; // Chain was stopped
                
                // Handle group fetch response
                if (groupResp.ok) {
                    return groupResp.json();
                } else if (groupResp.status === 404) {
                    // Fallback: endpoint not available, try fetching all groups
                    console.warn('Person groups endpoint not available, using fallback');
                    return fetch(`${javaURI}/api/groups`, fetchOptions)
                        .then(fallbackResp => {
                            if (!fallbackResp.ok) return [];
                            return fallbackResp.json().then(allGroups => {
                                // Filter client-side (less efficient fallback)
                                return (Array.isArray(allGroups) ? allGroups : []).filter(group =>
                                    Array.isArray(group.members) && group.members.some(m => m.uid === currentUid)
                                );
                            });
                        });
                }
                throw new Error('Failed to fetch group data');
            })
            .then(userGroups => {
                if (!userGroups) return; // Chain was stopped
                
                const groups = Array.isArray(userGroups) ? userGroups : [];

                // Build a Set of user's group IDs for O(1) lookup during search
                groups.forEach(group => userGroupIds.add(group.id));

                if (groups.length > 0) {
                    springGroupInfo.innerHTML = groups.map(group => `
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Group Name</label>
                        <input type="text" readonly
                            class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 text-gray-300 focus:outline-none cursor-default"
                            value="${group.name}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Period</label>
                        <input type="text" readonly
                            class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 text-gray-300 focus:outline-none cursor-default"
                            value="${group.period}">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Members & GitHub IDs</label>
                        <div class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 text-gray-300">
                            ${group.members.map(member => `${member.name} (${member.uid})`).join(', ')}
                        </div>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <button type="button" class="px-4 py-2 bg-red-400 text-white rounded-lg hover:bg-red-600 transition-colors" onclick="leaveGroup('${group.id}', ${currentPersonId})">
                            Leave Group
                        </button>
                    </div>
                    `).join('');
                } else {
                    springGroupInfo.innerHTML = `<p class="text-gray-400 col-span-2 text-center">No group assignments found.</p>`;
                }

                // Set up search functionality (uses cached personId)
                setupGroupSearch(groupSearchInput, groupResultsList, joinGroupStatus, userGroupIds, currentPersonId);
            })
            .catch(error => {
                console.error("Error in API chain:", error);
                springGroupInfo.innerHTML = `<p class="text-red-400 col-span-2 text-center">Error loading group information.</p>`;
                groupSearchInput.disabled = true;
            });

        /**
         * Set up group search and join functionality
         * Separated into a function to keep the main chain clean
         */
        function setupGroupSearch(groupSearchInput, groupResultsList, joinGroupStatus, userGroupIds, personId) {
            // Search function using server-side API
            const searchGroups = async (query) => {
                const normalized = query.trim();
                
                if (!normalized) {
                    groupResultsList.classList.add('hidden');
                    return;
                }

                try {
                    const searchResp = await fetch(`${javaURI}/api/groups/search?name=${encodeURIComponent(normalized)}`, fetchOptions);
                    if (!searchResp.ok) throw new Error('Search failed');
                    
                    const filtered = await searchResp.json();

                    if (filtered.length === 0) {
                        groupResultsList.innerHTML = `<div class="px-4 py-3 text-gray-400 text-sm">No matching groups</div>`;
                        groupResultsList.classList.remove('hidden');
                        return;
                    }

                    groupResultsList.innerHTML = filtered.map(group => {
                        const label = `${group.name || 'Unnamed'} (Period ${group.period || 'N/A'})`;
                        const isAlreadyMember = userGroupIds.has(group.id);
                        const disabledClass = isAlreadyMember ? 'opacity-50 cursor-not-allowed' : 'hover:bg-neutral-600 cursor-pointer';
                        const membersText = group.members?.length > 0 
                            ? group.members.map(m => m.name).join(', ')
                            : 'No members';
                        return `
                            <div data-group-id="${group.id}" class="px-4 py-3 border-b border-gray-600 last:border-b-0 text-gray-300 ${disabledClass} transition-colors"
                                onclick="joinGroupFromList('${group.id}', '${label}', ${isAlreadyMember})">
                                <div class="font-medium">${label}</div>
                                <div class="text-xs text-gray-500 mt-1">${membersText}</div>
                                ${isAlreadyMember ? '<div class="text-xs text-gray-400 mt-1">Already a member</div>' : ''}
                            </div>
                        `;
                    }).join('');
                    groupResultsList.classList.remove('hidden');
                } catch (error) {
                    console.error('Search error:', error);
                    groupResultsList.innerHTML = `<div class="px-4 py-3 text-red-400 text-sm">Search failed</div>`;
                    groupResultsList.classList.remove('hidden');
                }
            };

            // Search button click handler
            document.getElementById('groupSearchBtn')?.addEventListener('click', () => {
                searchGroups(groupSearchInput.value);
            });

            // Optimized join function - uses cached personId instead of fetching all people
            // This demonstrates how the cached personId from the initial chain is reused
            window.joinGroupFromList = async (groupId, groupLabel, isAlreadyMember) => {
                if (isAlreadyMember) {
                    joinGroupStatus.textContent = 'You are already a member of this group.';
                    return;
                }

                groupSearchInput.disabled = true;
                joinGroupStatus.textContent = 'Joining group...';
                groupResultsList.classList.add('hidden');

                // Use cached personId - no additional API call needed!
                if (!personId) {
                    joinGroupStatus.textContent = 'User ID not available. Please refresh the page.';
                    groupSearchInput.disabled = false;
                    return;
                }

                // Join group using the cached person ID from the initial chain
                fetch(`${javaURI}/api/groups/${groupId}/members/${personId}`, {
                    ...fetchOptions,
                    method: 'POST',
                })
                .then(joinResp => {
                    if (!joinResp.ok) {
                        return joinResp.text().then(body => {
                            throw new Error(body || 'Failed to join group');
                        });
                    }
                    joinGroupStatus.textContent = 'Refreshing...';
                    window.location.reload();
                })
                .catch(joinError => {
                    console.error('Join group error:', joinError);
                    joinGroupStatus.textContent = joinError.message || 'Unable to join group.';
                    groupSearchInput.disabled = false;
                });
            };
        }
    });
</script>

<div class="flex justify-between items-center mb-8">
    <button id="saveChangesBtn" disabled
        class="px-6 py-2 bg-neutral-300 text-gray-500 cursor-not-allowed rounded-lg transition-all duration-300"
        onclick="saveChanges()">
        Save Changes
    </button>
</div>

<!-- toasts -->
<script type="module">
    // import the toast handler module
    import { showToast } from "{{site.baseurl}}/assets/js/aesthetihawk/shared/toastHandler.js";

    window.addEventListener('load', () => {
        const callToast = document.querySelector("#saveChangesBtn");

        callToast.addEventListener("click", () => {
            showToast({
                message: "Changes Saved.",
                icon: `<svg class="size-5 text-teal-400" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                    </svg>`,
                duration: 3000
            });
        });
    });
</script>
<script type="module">
    import { pythonURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';


    async function loadPersonas() {
        const container = document.getElementById('personaSelectionContainer');
        
        try {
            // Fetch all available personas
            const personasResp = await fetch(`${pythonURI}/api/persona`, fetchOptions); 
            if (!personasResp.ok) throw new Error('Failed to load personas');
            const personas = await personasResp.json();
            
            console.log('üì¶ All personas loaded:', personas);
            
            // Get user's personas
            const userPersonasResp = await fetch(`${pythonURI}/api/user/personas`, fetchOptions); 
            
            let selectedPersonas = {};
            let totalSelected = 0;
            
            if (!userPersonasResp.ok) {
                console.log('‚ö†Ô∏è No personas found for user or not authenticated');
                showPersonaSelectionCards(personas, {});
                return;
            }
            
            const userPersonasData = await userPersonasResp.json();
            console.log('üë§ User personas data:', userPersonasData);
            
            selectedPersonas = userPersonasData.personas || {};
            totalSelected = userPersonasData.total_selected || 0;
            
            console.log('‚úÖ Selected personas:', selectedPersonas);
            console.log('üìä Total selected:', totalSelected);
            
            // Store globally
            window.allPersonasData = personas;
            window.selectedPersonasData = selectedPersonas;
            
            // If user has selected all 4 categories, show the completed view
            if (totalSelected === 4) {
                console.log('üéâ All 4 selected! Showing completed view');
                showCompletedPersonas(selectedPersonas, personas);
            } else {
                console.log('üìù Showing selection interface (', totalSelected, '/4 selected)');
                // Show selection interface - hide completed categories
                showPersonaSelectionCards(personas, selectedPersonas);
            }
            
        } catch (error) {
            console.error('‚ùå Error loading personas:', error);
            container.innerHTML = `
                <p class="text-red-400 text-center py-4">Error loading personas. Please try again later.</p>
                <p class="text-gray-500 text-center text-sm">${error.message}</p>
            `;
        }
    }
    function editProfile() {
        console.log('üìù Edit profile clicked - showing all categories');
        
        if (window.allPersonasData && window.selectedPersonasData) {
            showPersonaSelectionCards(window.allPersonasData, window.selectedPersonasData, true); // Pass true to force show all
        } else {
            loadPersonas();
        }
    }
    function showPersonaSelectionCards(allPersonas, selectedPersonas, forceShowAll = false) {
        const container = document.getElementById('personaSelectionContainer');
        
        console.log('üé® Rendering selection cards');
        console.log('Total personas:', allPersonas.length);
        console.log('Selected:', selectedPersonas);
        console.log('Force show all:', forceShowAll);
        
        if (allPersonas.length === 0) {
            container.innerHTML = `
                <p class="text-gray-400 text-center py-4">No personas available.</p>
            `;
            return;
        }
        
        // Group personas by category
        const grouped = allPersonas.reduce((acc, persona) => {
            const category = persona.category || 'other';
            if (!acc[category]) acc[category] = [];
            acc[category].push(persona);
            return acc;
        }, {});
        
        console.log('üìÇ Grouped by category:', grouped);
        
        const categoryLabels = {
            'student': 'Student Archetype',
            'social': 'Social Interest',
            'achievement': 'Achievement Oriented',
            'fantasy': 'Fantasy Persona'
        };
        
        const categoryDescriptions = {
            'student': 'How you approach learning and teamwork',
            'social': 'Your hobbies and social interests',
            'achievement': 'What drives and motivates you',
            'fantasy': 'Your aspirational superpower'
        };
        
        const categoryOrder = ['student', 'social', 'achievement', 'fantasy'];
        const totalSelected = Object.keys(selectedPersonas).length;
        
        container.innerHTML = `
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-100 mb-2">Build Your Persona Profile</h2>
                <p class="text-gray-400">Select one persona from each category (${totalSelected}/4 selected)</p>
                <div class="mt-4 flex justify-center gap-2">
                    ${categoryOrder.map(cat => `
                        <div class="w-3 h-3 rounded-full ${selectedPersonas[cat] ? 'bg-indigo-500' : 'bg-gray-700'}"></div>
                    `).join('')}
                </div>
            </div>
            
            <div class="space-y-8">
                ${categoryOrder.map(category => {
                    const personas = grouped[category] || [];
                    const selectedInCategory = selectedPersonas[category];
                    
                    // CHANGED: Only hide if NOT forcing show all AND category is selected
                    if (!forceShowAll && selectedInCategory) {
                        console.log(`‚úì Category ${category} already selected, hiding it`);
                        return '';
                    }
                    
                    // Show the selection grid
                    console.log(`üéØ Showing selection grid for ${category}`);
                    
                    return `
                        <div class="mb-8" id="category-${category}">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-300 flex items-center gap-2">
                                        ${selectedInCategory ? '‚úì' : '‚óã'} ${categoryLabels[category]}
                                        ${selectedInCategory ? '<span class="text-sm text-green-400 ml-2">(Currently selected)</span>' : ''}
                                    </h3>
                                    <p class="text-sm text-gray-500">${categoryDescriptions[category]}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="category-grid-${category}">
                                ${personas.map(persona => {
                                    const title = persona.bio_map?.title || persona.alias || 'Unnamed';
                                    const description = persona.bio_map?.description || 'No description';
                                    const isCurrentlySelected = selectedInCategory && selectedInCategory.persona_id === persona.id;
                                    
                                    return `
                                        <div 
                                            id="persona-card-${persona.id}"
                                            class="flex flex-col p-4 ${isCurrentlySelected ? 'bg-indigo-900 border-indigo-400' : 'bg-neutral-800 hover:bg-neutral-700'} border ${isCurrentlySelected ? 'border-indigo-400' : 'border-gray-700 hover:border-indigo-500'} rounded-lg cursor-pointer transition-all group h-full relative"
                                            onclick="selectPersona(${persona.id}, '${category}')">
                                            
                                            <div class="loading-overlay hidden absolute inset-0 bg-black/70 rounded-lg flex items-center justify-center z-10">
                                                <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            </div>
                                            
                                            ${isCurrentlySelected ? '<div class="absolute top-2 right-2 bg-indigo-500 text-white rounded-full p-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg></div>' : ''}
                                            
                                            <h4 class="font-semibold ${isCurrentlySelected ? 'text-indigo-200' : 'text-gray-200 group-hover:text-indigo-300'} mb-2">
                                                ${title}
                                            </h4>
                                            <p class="text-sm text-gray-400 flex-1 line-clamp-3">${description}</p>
                                            
                                            <div class="mt-3 flex justify-end">
                                                <svg class="w-6 h-6 text-gray-600 group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    function showCompletedPersonas(selectedPersonas, allPersonas) {
        const container = document.getElementById('personaSelectionContainer');
        
        const categoryLabels = {
            'student': 'Student Archetype',
            'social': 'Social Interest',
            'achievement': 'Achievement Oriented',
            'fantasy': 'Fantasy Persona'
        };
        
        const categoryEmojis = {
            'student': 'üìö',
            'social': 'üéâ',
            'achievement': 'üèÜ',
            'fantasy': '‚ú®'
        };
        
        const categoryOrder = ['student', 'social', 'achievement', 'fantasy'];
        
        container.innerHTML = `
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-100 mb-2">Your Persona Profile</h2>
                        <p class="text-gray-400">These personas represent your personality and preferences</p>
                    </div>
                    <button 
                        onclick="editProfile()"
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Change Personas
                    </button>
                </div>
                
                <!-- 2x2 Grid of Selected Personas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${categoryOrder.map(category => {
                        const personaData = selectedPersonas[category];
                        if (!personaData) return '';
                        
                        const persona = allPersonas.find(p => p.id === personaData.persona_id);
                        if (!persona) return '';
                        
                        const title = persona.bio_map?.title || persona.alias || 'Unnamed';
                        const description = persona.bio_map?.description || 'No description';
                        const empathyMap = persona.empathy_map || {};
                        
                        return `
                            <div class="bg-gradient-to-br from-indigo-900/20 to-purple-900/20 border-2 border-indigo-500/50 rounded-xl p-6 hover:border-indigo-500 transition">
                                
                                <div class="flex items-start gap-4 mb-4">
                                    <div class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-2xl flex-shrink-0">
                                        ${categoryEmojis[category]}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs font-medium text-indigo-400 uppercase">${categoryLabels[category]}</span>
                                        </div>
                                        <h3 class="text-xl font-bold text-gray-100">${title}</h3>
                                    </div>
                                </div>
                                
                                <p class="text-gray-300 text-sm leading-relaxed mb-4">${description}</p>
                                
                                ${empathyMap.says?.length || empathyMap.thinks?.length ? `
                                    <div class="border-t border-gray-700 pt-4">
                                        <div class="space-y-3">
                                            ${empathyMap.says?.[0] ? `
                                                <div class="flex items-start gap-2">
                                                    <span class="text-blue-400 text-xs font-medium mt-0.5">üí¨</span>
                                                    <p class="text-gray-400 text-xs italic flex-1">"${empathyMap.says[0]}"</p>
                                                </div>
                                            ` : ''}
                                            ${empathyMap.thinks?.[0] ? `
                                                <div class="flex items-start gap-2">
                                                    <span class="text-purple-400 text-xs font-medium mt-0.5">üí≠</span>
                                                    <p class="text-gray-400 text-xs flex-1">${empathyMap.thinks[0]}</p>
                                                </div>
                                            ` : ''}
                                            ${empathyMap.does?.[0] ? `
                                                <div class="flex items-start gap-2">
                                                    <span class="text-green-400 text-xs font-medium mt-0.5">‚úã</span>
                                                    <p class="text-gray-400 text-xs flex-1">${empathyMap.does[0]}</p>
                                                </div>
                                            ` : ''}
                                            ${empathyMap.feels?.[0] ? `
                                                <div class="flex items-start gap-2">
                                                    <span class="text-pink-400 text-xs font-medium mt-0.5">‚ù§Ô∏è</span>
                                                    <p class="text-gray-400 text-xs flex-1">${empathyMap.feels[0]}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    async function selectPersona(personaId, category) {
        console.log('üéØ SELECT PERSONA CALLED');
        console.log('   Persona ID:', personaId);
        console.log('   Category:', category);
        
        // Show loading state on the clicked card
        const card = document.getElementById(`persona-card-${personaId}`);
        if (card) {
            card.style.position = 'relative';
            const overlay = card.querySelector('.loading-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                console.log('   ‚úÖ Loading overlay shown');
            }
            card.style.pointerEvents = 'none';
        }
        
        try {
            const url = `${pythonURI}/api/user/persona`;
            const body = { persona_id: personaId };
            
            console.log('üì§ Making POST request');
            console.log('   URL:', url);
            console.log('   Body:', body);
            
            const response = await fetch(url, {
                ...fetchOptions,
                method: 'POST',
                body: JSON.stringify(body)
            });
            
            console.log('üì• Response received');
            console.log('   Status:', response.status);
            console.log('   OK:', response.ok);
            
            const responseData = await response.json();
            console.log('   Response Data:', responseData);
            
            if (!response.ok) {
                throw new Error(responseData.message || `Server error: ${response.status}`);
            }
            
            console.log('‚úÖ Selection successful!');
            
            // Show success animation
            if (card) {
                const overlay = card.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.innerHTML = `
                        <svg class="h-12 w-12 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    `;
                    console.log('   ‚úÖ Success checkmark shown');
                }
            }
            
            // Wait a moment then reload
            console.log('   ‚è≥ Waiting 600ms before reload...');
            setTimeout(() => {
                console.log('   üîÑ Reloading personas...');
                loadPersonas();
            }, 600);
            
        } catch (error) {
            console.error('‚ùå ERROR in selectPersona:', error);
            
            // Hide loading overlay and restore interactivity
            if (card) {
                const overlay = card.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                }
                card.style.pointerEvents = 'auto';
            }
            
            // Show error message
            const categorySection = document.getElementById(`category-${category}`);
            if (categorySection) {
                const existingError = categorySection.querySelector('.error-message');
                if (existingError) existingError.remove();
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message bg-red-900/30 border border-red-500 rounded-lg p-4 mb-4 flex items-start gap-3';
                errorDiv.innerHTML = `
                    <svg class="w-6 h-6 text-red-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <div class="flex-1">
                        <h4 class="text-red-400 font-semibold mb-1">Selection Failed</h4>
                        <p class="text-red-300 text-sm">${error.message}</p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                `;
                categorySection.insertBefore(errorDiv, categorySection.querySelector(`#category-grid-${category}`));
                
                setTimeout(() => errorDiv.remove(), 5000);
            }
        }
    }
    // Make functions globally accessible
    window.loadPersonas = loadPersonas;
    window.selectPersona = selectPersona;
    window.editProfile = editProfile;
    window.showPersonaSelectionCards = showPersonaSelectionCards;
    window.showCompletedPersonas = showCompletedPersonas;
    document.addEventListener("DOMContentLoaded", () => {
        loadPersonas();
    });
</script>
<script type="module">
    import { pythonURI, javaURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';
    import { putUpdate, postUpdate, deleteData, logoutUserJava } from "{{site.baseurl}}/assets/js/api/profile.js";

    // external functions
    import { getUserData } from '{{site.baseurl}}/assets/js/aesthetihawk/profile/getUserData.js';
    import { setUserData } from '{{site.baseurl}}/assets/js/aesthetihawk/profile/setUserData.js';

    // this runs on page load
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            await window.setUserData();
        } catch (error) {
            console.error("Error initializing user data:", error.message);
        }
    });

    // make it run constantly to check for esc key press
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            document.getElementById('change-pfp').style.visibility = 'hidden';
            document.getElementById('change-class').style.visibility = 'hidden';
        }
    });

    // Attach the function to the global window object
    window.openChangePfpModal = function () {
        const changePfpBox = document.getElementById('change-pfp');
        console.log("Change pfp button clicked");
        if (changePfpBox) {
            changePfpBox.style.visibility = 'visible';
        } else {
            console.error('Change PFP modal not found in the DOM.');
        }
    };

    window.changeProfilePictureWithPath = async function (imagePath) {
        try {
            // Fetch the image and convert it to a Blob
            const response = await fetch(imagePath);
            const blob = await response.blob();

            // Convert the Blob to a base64 string
            const base64String = await convertToBase64(blob);

            // Send the base64 image to the backend
            await sendProfilePicture(base64String);
            console.log('Profile picture updated to steve.png successfully!');
        } catch (error) {
            console.error('Error updating profile picture to steve.png:', error.message);
        }
    };

    window.getUserData = getUserData; // get the data
    window.setUserData = setUserData; // setting the user data to display
    // NOTE: Removed duplicate DOMContentLoaded listener that called setUserData()
    // setUserData() is already called once at line ~427, calling it twice causes
    // redundant API requests. This is an example of optimizing by removing duplicate calls.

    window.changeClass = async function (event) {
        event.preventDefault(); // Prevent the form from refreshing the page
        // change the class info p box
        const classInput = document.getElementById("classInput").value;
        const classInputYear = document.getElementById("classInputYear").value;
        const classDisplayedInfo = document.getElementById("classDisplayedInfo");
        classDisplayedInfo.textContent = classInput + " " + classInputYear;
    }

    window.changeProfilePicture = async function (event) {
        event.preventDefault(); // Prevent the form from refreshing the page

        // select the file
        const fileInput = document.getElementById('profilePictureInput');
        const file = fileInput.files[0];

        // all this does is update the image in the sidebar (doesnt actually send img to backend)
        if (file) {
            const reader = new FileReader();
            reader.onload = function () {
                const profileImageBox = document.getElementById('headerPfp');
                profileImageBox.innerHTML = `<img src="${reader.result}" alt="Profile Picture">`;
            };
            reader.readAsDataURL(file);
        }
        if (!file) return;

        // this is the code that ACTUALLY sends the file to the backend
        try {
            const base64String = await convertToBase64(file);
            await sendProfilePicture(base64String);
            console.log('Profile picture uploaded successfully!');
        } catch (error) {
            console.error('Error uploading profile picture:', error.message);
        }

        await new Promise(resolve => setTimeout(resolve, 250));
        window.location.reload();
    }

    // helper function to convert a file to base64 for payload
    async function convertToBase64(fileOrBlob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(fileOrBlob);
        });
    }

    async function sendProfilePicture(base64String) {
        const URL = javaURI + "/api/person/update"; // Adjust endpoint as needed

        // Create options object for PUT request
        const options = {
            URL,
            body: { pfp: base64String },
            message: 'profile-message', // Adjust the message area as needed
            callback: () => {
                console.log('Profile picture uploaded successfully!');
            }
        };

        try {
            await postUpdate(options);
        } catch (error) {
            console.error('Error uploading profile picture:', error.message);
        }
    }
</script>

<script type="module">
    import { pythonURI, javaURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';
    // Store original form values
    let originalValues = {};
    let formChanged = false;
    let currentUserClasses = []; // ADD THIS LINE

    // how long toast stays (ms)
    const toastDuration = 10000;

    // Initialize the form
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOMContentLoaded fired'); // ADD THIS
        
        // Store original values
        saveOriginalValues();
        
        // Load user classes
        loadUserClasses();

        const form = document.getElementById('profileSettingsForm');
        form.addEventListener('input', checkForChanges);
        form.addEventListener('change', checkForChanges);

        // Attach event listener to Add Class button
        const addClassBtn = document.getElementById('addClassBtn');
        console.log('Add Class Button:', addClassBtn); // ADD THIS
        if (addClassBtn) {
            addClassBtn.addEventListener('click', function() {
                console.log('Add Class button clicked!'); // ADD THIS
                addClass();
            });
        } else {
            console.error('addClassBtn not found!'); // ADD THIS
        }

        // Set up toggle switch
        const toggle = document.querySelector('#kasmChangeInput');
        const toggleDot = document.querySelector('.dot');

        toggle.addEventListener('change', function () {
            if (this.checked) {
                toggleDot.classList.add('translate-x-3');
                toggle.classList.add('bg-blue-600');
            } else {
                toggleDot.classList.remove('translate-x-3');
                toggle.classList.remove('bg-blue-600');
            }
        });
    });
    
    // Save original form values
    function saveOriginalValues() {
        const form = document.getElementById('profileSettingsForm');
        const inputs = form.querySelectorAll('input, select');

        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                originalValues[input.id] = input.checked;
            } else {
                originalValues[input.id] = input.value;
            }
        });

        // Save original class entries
        const classEntries = document.querySelectorAll('.class-entry');
        originalValues.classEntries = [];

        classEntries.forEach((entry, index) => {
            originalValues.classEntries[index] = {
                name: entry.querySelector('.class-name').value,
                //year: entry.querySelector('.class-year').value
            };
        });
    }

    // Check if form values have changed
    function checkForChanges() {
        const form = document.getElementById('profileSettingsForm');
        const inputs = form.querySelectorAll('input, select');
        const saveButton = document.getElementById('saveChangesBtn');

        formChanged = false;

        // Check standard inputs - only compare if they have original values
        inputs.forEach(input => {
            // Skip if this input doesn't have an id
            if (!input.id) return;

            if (input.type === 'checkbox') {
                if (originalValues[input.id] !== undefined && originalValues[input.id] !== input.checked) {
                    formChanged = true;
                }
            } else {
                if (originalValues[input.id] !== undefined && originalValues[input.id] !== input.value) {
                    formChanged = true;
                }
            }
        });

        // Check class entries
        const classEntries = document.querySelectorAll('.class-entry');
        if (classEntries.length !== (originalValues.classEntries?.length || 0)) {
            formChanged = true;
        }

        // Update save button
        if (formChanged) {
            saveButton.disabled = false;
            saveButton.classList.remove('bg-neutral-300', 'text-neutral-500', 'cursor-not-allowed');
            saveButton.classList.add('bg-indigo-500', 'text-white', 'hover:bg-indigo-600');
        } else {
            saveButton.disabled = true;
            saveButton.classList.add('bg-neutral-300', 'text-neutral-500', 'cursor-not-allowed');
            saveButton.classList.remove('bg-indigo-500', 'text-white', 'hover:bg-indigo-600');
        }
    }
    
    async function loadUserClasses() {
        try {
            const response = await fetch(`${pythonURI}/api/user/class`, fetchOptions); 
            if (!response.ok) {
                console.error('Failed to load classes');
                return;
            }

            const data = await response.json();
            currentUserClasses = data.class || [];
            renderClasses(currentUserClasses);
        } catch (error) {
            console.error('Error loading classes:', error);
        }
    }

    // Render classes in the UI
    function renderClasses(classes) {
        const container = document.getElementById('classesContainer');
        
        if (!container) return;

        if (!classes || classes.length === 0) {
            container.innerHTML = `
                <p class="text-gray-400 text-center py-4">No classes added yet. Click "Add Class" to get started.</p>
            `;
            return;
        }

        container.innerHTML = classes.map((classAbbr, index) => `
            <div class="class-entry mb-4 p-4 border rounded-lg border-neutral-700" data-index="${index}">
                <div class="flex flex-col md:flex-row md:space-x-4 mb-2">
                    <div class="flex-grow mb-2 md:mb-0">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Class Name</label>
                        <select class="class-name w-full px-4 py-2 rounded-lg border border-gray-600 bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" onchange="updateClassInAPI(${index}, this.value)">
                            <option value="CSSE" ${classAbbr === 'CSSE' ? 'selected' : ''}>Computer Science and Software Engineering</option>
                            <option value="CSP" ${classAbbr === 'CSP' ? 'selected' : ''}>Computer Science Principles</option>
                            <option value="CSA" ${classAbbr === 'CSA' ? 'selected' : ''}>Computer Science A</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="text-red-500 hover:text-red-700 text-sm font-medium" onclick="removeClass(this)">
                    Remove
                </button>
            </div>
        `).join('');
    }

    // Add new class
    async function addClass() {
        // Determine which class to add
        let newClass = 'CSP';
        if (currentUserClasses.includes('CSP')) {
            if (!currentUserClasses.includes('CSSE')) newClass = 'CSSE';
            else if (!currentUserClasses.includes('CSA')) newClass = 'CSA';
            else {
                alert('All available classes have been added.');
                return;
            }
        }

        try {
            const response = await fetch(`${pythonURI}/api/user/class`, {
                ...fetchOptions,
                method: 'POST',
                body: JSON.stringify({ class: newClass })
            });

            if (!response.ok) throw new Error('Failed to add class');

            const data = await response.json();
            currentUserClasses = data.class || [];
            renderClasses(currentUserClasses);
            checkForChanges();
        } catch (error) {
            console.error('Error adding class:', error);
            alert('Error adding class. Please try again.');
        }
    }

    // Remove a class
    async function removeClass(button) {
        const entry = button.closest('.class-entry');
        const index = parseInt(entry.dataset.index);
        const classToRemove = currentUserClasses[index];

        try {
            // Use POST with action parameter instead of DELETE
            const response = await fetch(`${pythonURI}/api/user/class`, {
                ...fetchOptions,
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'remove',
                    class: classToRemove 
                })
            });

            if (!response.ok) throw new Error('Failed to remove class');

            const data = await response.json();
            currentUserClasses = data.class || [];
            renderClasses(currentUserClasses);
            checkForChanges();
        } catch (error) {
            console.error('Error removing class:', error);
            alert('Error removing class. Please try again.');
        }
    }

    async function updateClassInAPI(index, newClass) {
        const updatedClasses = [...currentUserClasses];
        updatedClasses[index] = newClass;

        try {
            const response = await fetch(`${pythonURI}/api/user/class`, {
                ...fetchOptions,
                method: 'PUT',
                body: JSON.stringify({ class: updatedClasses })
            });

            if (!response.ok) throw new Error('Failed to update class');

            const data = await response.json();
            currentUserClasses = data.class || [];
            renderClasses(currentUserClasses);
            checkForChanges();
        } catch (error) {
            console.error('Error updating class:', error);
            alert('Error updating class. Please try again.');
            renderClasses(currentUserClasses); // Revert on error
        }
    }

    // Fetch grade prediction from academic grade predictor API
    async function fetchGradePrediction() {
        const uidInput = document.getElementById("uidChangeInput");
        const uid = uidInput.value.trim();

        if (!uid) {
            console.error('User ID is required to fetch grade prediction');
            alert('Please ensure your User ID is set before fetching grade prediction.');
            return;
        }

        try {
            const response = await fetch(`${pythonURI}/api/grade-prediction/${uid}`, fetchOptions); 
            if (!response.ok) {
                throw new Error(`Failed to fetch grade prediction: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('Grade Prediction Data:', data);
            
            // Process and display the grade prediction data
            if (data && data.prediction) {
                displayGradePrediction(data);
            } else {
                console.warn('No prediction data available');
            }

            return data;
        } catch (error) {
            console.error('Error fetching grade prediction:', error.message);
            alert(`Error fetching grade prediction: ${error.message}`);
            return null;
        }
    }

    // Display grade prediction results
    function displayGradePrediction(data) {
        console.log('Displaying grade prediction:', data);
        
        // You can add UI elements here to display the prediction
        // For now, just log to console
        if (data.prediction) {
            console.log(`Predicted Grade: ${data.prediction.grade}`);
            console.log(`Confidence: ${data.prediction.confidence || 'N/A'}`);
            console.log(`Prediction Details:`, data.prediction);
        }
    }

    // save all changes in one go
    async function saveChanges() {
        // get references to inputs
        const nameInput = document.getElementById("nameChangeInput");
        const uidInput = document.getElementById("uidChangeInput");
        const emailInput = document.getElementById("emailChangeInput");
        const sidInput = document.getElementById("sidChangeInput");
        const passwordInput = document.getElementById("password");
        const kasmInput = document.getElementById("kasmChangeInput");
        const schoolInput = document.getElementById("schoolChangeInput");

        // get values
        const name = nameInput.value.trim();
        const uid = uidInput.value.trim();
        const email = emailInput.value.trim();
        const sid = sidInput.value.trim();
        const password = passwordInput.value.trim();
        const kasmServerNeeded = kasmInput ? kasmInput.checked : undefined;
        const school = schoolInput.value;

        // get class info
        const classEntries = Array.from(document.querySelectorAll('.class-entry')).map(entry => ({
            name: entry.querySelector('.class-name').value,
            //year: entry.querySelector('.class-year').value
        }));

        // import api helpers
        const { putUpdate, postUpdate } = await import("{{site.baseurl}}/assets/js/api/profile.js");
        const { javaURI, pythonURI } = await import("{{site.baseurl}}/assets/js/api/config.js");

        // track if we need to reload or logout
        let needsReload = false;
        let needsLogout = false;

        // save name (both backends)
        if (name && name !== originalValues["nameChangeInput"]) {
            try {
                await Promise.all([
                    putUpdate({
                        URL: pythonURI + "/api/user",
                        body: { name },
                        message: 'name-message'
                    }),
                    postUpdate({
                        URL: javaURI + "/api/person/update",
                        body: { name }
                    })
                ]);
                needsReload = true;
            } catch (e) {
                console.error("error saving name:", e.message);
            }
        }

        // save uid (both backends, logs out)
        if (uid && uid !== originalValues["uidChangeInput"]) {
            try {
                await Promise.all([
                    putUpdate({
                        URL: pythonURI + "/api/user",
                        body: { uid },
                        message: 'uid-message'
                    }),
                    postUpdate({
                        URL: javaURI + "/api/person/update",
                        body: { uid }
                    })
                ]);
                needsLogout = true;
            } catch (e) {
                console.error("error saving uid:", e.message);
            }
        }

        // save email (both backends)
        if (email && email !== originalValues["emailChangeInput"]) {
            try {
                await Promise.all([
                    putUpdate({
                        URL: pythonURI + "/api/user",
                        body: { email },
                        message: 'email-message'
                    }),
                    postUpdate({
                        URL: javaURI + "/api/person/update",
                        body: { email }
                    })
                ]);
            } catch (e) {
                console.error("error saving email:", e.message);
            }
        }

        // save student ID (both backends)
        if (sid && sid !== originalValues["sidChangeInput"]) {
            try {
                await Promise.all([
                    putUpdate({
                        URL: pythonURI + "/api/user",
                        body: { sid },
                        message: 'sid-message'
                    }),
                    postUpdate({
                        URL: javaURI + "/api/person/update",
                        body: { sid }
                    })
                ]);
            } catch (e) {
                console.error("error saving student ID:", e.message);
            }
        }

        // save password (both backends, logs out)
        if (password) {
            try {
                await Promise.all([
                    putUpdate({
                        URL: pythonURI + "/api/user",
                        body: { password },
                        message: 'password-message'
                    }),
                    postUpdate({
                        URL: javaURI + "/api/person/update",
                        body: { password }
                    })
                ]);
                needsLogout = true;
            } catch (e) {
                console.error("error saving password:", e.message);
            }
        }

        // save kasm server status (both backends)
        if (
            typeof kasmServerNeeded !== "undefined" &&
            kasmServerNeeded !== originalValues["kasmChangeInput"]
        ) {
            try {
                await Promise.all([
                    putUpdate({
                        URL: pythonURI + "/api/user",
                        body: { kasmServerNeeded },
                        message: 'kasm-message'
                    }),
                    postUpdate({
                        URL: javaURI + "/api/person/update",
                        body: { kasmServerNeeded }
                    })
                ]);
            } catch (e) {
                console.error("error saving kasm server status:", e.message);
            }
        }

        // save school (both backends)
        if (school && school !== originalValues["schoolChangeInput"]) {
            try {
                await Promise.all([
                    putUpdate({
                        URL: pythonURI + "/api/user",
                        body: { school },
                        message: 'school-message'
                    }),
                    postUpdate({
                        URL: javaURI + "/api/person/update",
                        body: { school }
                    })
                ]);
                needsReload = true;
            } catch (e) {
                console.error("error saving school:", e.message);
            }
        }

        // save classes (implement as needed)
        // you can add your own logic here to send classEntries to backend

        // update original values and ui
        saveOriginalValues();
        formChanged = false;

        const saveButton = document.getElementById('saveChangesBtn');
        saveButton.disabled = true;
        saveButton.classList.add('bg-neutral-300', 'text-neutral-500', 'cursor-not-allowed');
        saveButton.classList.remove('bg-indigo-500', 'text-white', 'hover:bg-indigo-600');

        // show success message
        const originalButtonText = saveButton.innerHTML;
        saveButton.innerHTML = `
            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Saved!
        `;

        setTimeout(() => {
            saveButton.innerHTML = originalButtonText;
        }, 2000);

        // handle reload or logout if needed
        if (needsLogout) {
            alert("you updated your github id or password, so you will be logged out. remember your new credentials!");
            window.location.href = '{{site.baseurl}}';
        } else if (needsReload) {
            window.location.reload();
        }
    }
    window.loadUserClasses = loadUserClasses;
    window.addClass = addClass;
    window.removeClass = removeClass;
    window.updateClassInAPI = updateClassInAPI;
    window.saveChanges = saveChanges;
    window.checkForChanges = checkForChanges;
    window.fetchGradePrediction = fetchGradePrediction;
    window.displayGradePrediction = displayGradePrediction;

    // Leave group function
    window.leaveGroup = async function(groupId, personId) {
        if (!confirm('Are you sure you want to leave this group?')) {
            return;
        }

        try {
            const response = await fetch(`${javaURI}/api/groups/${groupId}/members/${personId}`, {
                ...fetchOptions,
                method: 'DELETE',
            });

            if (!response.ok) {
                throw new Error(`Failed to leave group: ${response.statusText}`);
            }

            // alert('Successfully left the group.');
            window.location.reload();
        } catch (error) {
            console.error('Error leaving group:', error);
            alert(`Error leaving group: ${error.message}`);
        }
    };
</script>

<!-- Inject YAML data into the page as JSON (Jekyll) -->
<script id="gaDataset" type="application/json">
  {{ site.data.grouping_agent_sample | jsonify }}
</script>

<script type="module">
  // ============================
  // Frontend-only Grouping Agent
  // ============================

  const LS_MODEL = "ga_model_v1";
  const LS_HISTORY = "ga_history_v1"; // appended outcomes from UI

  const CATS = ["student", "social", "achievement", "fantasy"];

  const statusEl = document.getElementById("gaStatus");
  const outcomeStatusEl = document.getElementById("gaOutcomeStatus");
  const recsEl = document.getElementById("gaRecs");

  function readDataset() {
    const raw = document.getElementById("gaDataset")?.textContent?.trim();
    if (!raw) return { people: [], outcomes: [] };
    try { return JSON.parse(raw); } catch { return { people: [], outcomes: [] }; }
  }

  function load(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
    catch { return fallback; }
  }
  function save(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  function defaultModel() {
    return {
      version: 1,
      diversityWeights: { student: 1.0, social: 0.5, achievement: 1.0, fantasy: 0.2 },
      pairWeights: { student: {}, social: {}, achievement: {}, fantasy: {} },
      taskBias: { CSA_FRQ: 0.0, WEB_APP: 0.0, DATA_SCI: 0.0 },
      difficultyWeight: -0.05
    };
  }

  function pairKey(a, b) {
    const lo = Math.min(a, b), hi = Math.max(a, b);
    return `${lo}:${hi}`;
  }

  function diversity(personas, cat) {
    const s = new Set();
    for (const p of personas) {
      const v = p?.[cat];
      if (v !== undefined && v !== null) s.add(v);
    }
    return s.size;
  }

  function scoreGroup(model, personas, taskType, difficulty) {
    let s = 0;

    for (const cat of CATS) {
      s += (model.diversityWeights[cat] ?? 0) * diversity(personas, cat);
    }

    for (const cat of CATS) {
      const w = model.pairWeights[cat] ?? {};
      for (let i = 0; i < personas.length; i++) {
        for (let j = i + 1; j < personas.length; j++) {
          const a = personas[i]?.[cat];
          const b = personas[j]?.[cat];
          if (a == null || b == null) continue;
          s += (w[pairKey(a, b)] ?? 0);
        }
      }
    }

    s += (model.taskBias[taskType] ?? 0);
    s += (model.difficultyWeight ?? 0) * difficulty;
    return s;
  }

  function sigmoid(x) {
    return 1 / (1 + Math.exp(-x));
  }

  // Convert (student 1-5 + teacher 1-5) => single outcome score (0..100-ish)
  function combinedOutcomeScore(student1to5, teacher1to5) {
    // weight teacher a bit more (you can change)
    const combined = (0.4 * student1to5 + 0.6 * teacher1to5);
    // map 1..5 -> 20..100
    return (combined / 5) * 100;
  }

  function updateModelFromOutcome(model, personas, taskType, difficulty, outcomeScore100) {
    const lr = 0.01;
    const goodThreshold = 70; // outcomeScore >= 70 treated as "good"
    const y = outcomeScore100 >= goodThreshold ? 1 : 0;

    const predRaw = scoreGroup(model, personas, taskType, difficulty);
    const pred = sigmoid(predRaw);
    const err = (y - pred);

    for (const cat of CATS) {
      const div = diversity(personas, cat);
      model.diversityWeights[cat] = (model.diversityWeights[cat] ?? 0) + lr * err * div;
    }

    for (const cat of CATS) {
      const w = model.pairWeights[cat] ?? (model.pairWeights[cat] = {});
      for (let i = 0; i < personas.length; i++) {
        for (let j = i + 1; j < personas.length; j++) {
          const a = personas[i]?.[cat];
          const b = personas[j]?.[cat];
          if (a == null || b == null) continue;
          const k = pairKey(a, b);
          w[k] = (w[k] ?? 0) + lr * err;
        }
      }
    }

    model.taskBias[taskType] = (model.taskBias[taskType] ?? 0) + lr * err;
    model.difficultyWeight = (model.difficultyWeight ?? 0) + lr * err * difficulty;

    model.version += 1;
    return { predBefore: pred, err };
  }

  function recommendGroups(people, model, taskType, difficulty, groupSize) {
    const remaining = [...people];
    const recs = [];

    // shuffle
    for (let i = remaining.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
    }

    while (remaining.length >= 2) {
      const group = [remaining.shift()];

      while (group.length < groupSize && remaining.length > 0) {
        let bestIdx = -1;
        let bestScore = -1e9;

        for (let i = 0; i < remaining.length; i++) {
          const cand = remaining[i];
          const personas = [...group, cand].map(p => p.personas);
          const s = scoreGroup(model, personas, taskType, difficulty);
          if (s > bestScore) {
            bestScore = s;
            bestIdx = i;
          }
        }

        if (bestIdx === -1) break;
        group.push(remaining.splice(bestIdx, 1)[0]);
      }

      const finalScore = scoreGroup(model, group.map(p => p.personas), taskType, difficulty);
      recs.push({ members: group, score: finalScore });

      if (remaining.length < 2) break;
    }

    return recs;
  }

  function renderRecs(recs) {
    if (!recs.length) {
      recsEl.innerHTML = `<div class="text-gray-400 text-sm">No recommendations (need at least 2 people).</div>`;
      return;
    }

    recsEl.innerHTML = recs.map((g, idx) => `
      <div class="p-4 bg-neutral-700 rounded-lg border border-gray-600">
        <div class="flex items-center justify-between">
          <div class="font-semibold text-gray-100">Group ${idx + 1}</div>
          <div class="text-xs text-gray-300">Score: ${g.score.toFixed(3)}</div>
        </div>
        <div class="mt-2 text-sm text-gray-200">
          ${g.members.map(m => `${m.name} <span class="text-gray-400">(${m.id})</span>`).join(", ")}
        </div>
        <div class="mt-2 text-xs text-gray-400">
          Personas: ${g.members.map(m => `(${CATS.map(c => `${c}:${m.personas?.[c] ?? "?"}`).join(" | ")})`).join("  ‚Ä¢  ")}
        </div>
      </div>
    `).join("");
  }

  function getUIContext() {
    return {
      taskType: document.getElementById("gaTaskType").value,
      difficulty: parseInt(document.getElementById("gaDifficulty").value || "3", 10),
      groupSize: parseInt(document.getElementById("gaGroupSize").value || "4", 10),
    };
  }

  // --------- Wire up buttons ---------

  const dataset = readDataset();
  const basePeople = Array.isArray(dataset.people) ? dataset.people : [];
  const baseOutcomes = Array.isArray(dataset.outcomes) ? dataset.outcomes : [];

  if (!localStorage.getItem(LS_MODEL)) save(LS_MODEL, defaultModel());
  if (!localStorage.getItem(LS_HISTORY)) save(LS_HISTORY, []);

  function trainFromDatasetAndLocal() {
    const model = load(LS_MODEL, defaultModel());
    const localHistory = load(LS_HISTORY, []);

    const allRuns = [];

    // dataset runs
    for (const r of baseOutcomes) {
      const taskType = r?.task?.type ?? "CSA_FRQ";
      const difficulty = r?.task?.difficulty ?? 3;

      const student = r?.student_assessment?.avg_rating_1to5 ?? 3;
      const teacher = r?.teacher_assessment?.worked_rating_1to5 ?? 3;
      const score100 = combinedOutcomeScore(student, teacher);

      // personas snapshot is already present in YAML (best), but fallback to roster
      const members = r?.group?.members ?? [];
      const personasList = members.map(id => {
        const snap = r?.group?.personas_snapshot?.[id];
        if (snap) return snap;
        const p = basePeople.find(x => x.id === id);
        return p?.personas ?? null;
      }).filter(Boolean);

      if (personasList.length >= 2) {
        allRuns.push({ personasList, taskType, difficulty, score100 });
      }
    }

    // local history runs (saved from UI)
    for (const r of localHistory) {
      const taskType = r.taskType;
      const difficulty = r.difficulty;
      const score100 = r.score100;
      const personasList = r.personasList;
      if (Array.isArray(personasList) && personasList.length >= 2) {
        allRuns.push({ personasList, taskType, difficulty, score100 });
      }
    }

    // Train passes (single pass MVP)
    for (const run of allRuns) {
      updateModelFromOutcome(model, run.personasList, run.taskType, run.difficulty, run.score100);
    }

    save(LS_MODEL, model);
    return model;
  }

  document.getElementById("gaTrainBtn").addEventListener("click", () => {
    const model = trainFromDatasetAndLocal();
    statusEl.textContent = `Trained ‚úì (model v${model.version})`;
  });

  document.getElementById("gaRecommendBtn").addEventListener("click", () => {
    const model = load(LS_MODEL, defaultModel());
    const { taskType, difficulty, groupSize } = getUIContext();

    // Recommend over the roster from YAML
    const eligible = basePeople.filter(p => p?.personas && CATS.every(c => p.personas[c] != null));
    const recs = recommendGroups(eligible, model, taskType, difficulty, groupSize);

    statusEl.textContent = `Recommended ‚úì (model v${model.version})`;
    renderRecs(recs);
  });

  document.getElementById("gaSaveOutcomeBtn").addEventListener("click", () => {
    const { taskType, difficulty } = getUIContext();
    const membersRaw = document.getElementById("gaOutcomeMembers").value;
    const studentRating = parseInt(document.getElementById("gaStudentRating").value || "3", 10);
    const teacherRating = parseInt(document.getElementById("gaTeacherRating").value || "3", 10);

    const members = membersRaw.split(",").map(s => s.trim()).filter(Boolean);
    const people = basePeople;

    const persons = members.map(id => people.find(p => p.id === id)).filter(Boolean);
    if (persons.length < 2) {
      outcomeStatusEl.textContent = "Need at least 2 valid member IDs from the YAML roster (e.g., u1,u2,u3).";
      return;
    }

    const personasList = persons.map(p => p.personas);
    const score100 = combinedOutcomeScore(studentRating, teacherRating);

    const history = load(LS_HISTORY, []);
    history.push({
      ts: Date.now(),
      taskType,
      difficulty,
      members,
      studentRating,
      teacherRating,
      score100,
      personasList
    });
    save(LS_HISTORY, history);

    // update model immediately (so it feels like an agent)
    const model = load(LS_MODEL, defaultModel());
    const info = updateModelFromOutcome(model, personasList, taskType, difficulty, score100);
    save(LS_MODEL, model);

    outcomeStatusEl.textContent = `Saved ‚úì Model updated to v${model.version} (pred before update: ${(info.predBefore * 100).toFixed(1)}%)`;
    statusEl.textContent = `Model v${model.version}`;
  });

  document.getElementById("gaResetLocalBtn").addEventListener("click", () => {
    save(LS_MODEL, defaultModel());
    save(LS_HISTORY, []);
    statusEl.textContent = "Reset ‚úì";
    outcomeStatusEl.textContent = "Cleared local model + history.";
    recsEl.innerHTML = `<div class="text-gray-400 text-sm">No recommendations yet.</div>`;
  });

  // Initial status
  const model0 = load(LS_MODEL, defaultModel());
  statusEl.textContent = `Ready (model v${model0.version})`;
</script>